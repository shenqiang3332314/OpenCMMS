<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡å°è´¦ç®¡ç†</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-inactive { background: #fef3c7; color: #92400e; }
        .status-maintenance { background: #dbeafe; color: #1e40af; }
        .status-retired { background: #fee2e2; color: #991b1b; }
        .message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .message.success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .message.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .message.info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>è®¾å¤‡å°è´¦ç®¡ç†</h1>
        
        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <a href="/api/assets/download_template/" class="btn btn-secondary btn-sm" target="_blank">ğŸ“¥ ä¸‹è½½æ¨¡æ¿</a>
            <button class="btn btn-primary btn-sm" onclick="document.getElementById('importFile').click()">ğŸ“¤ æ‰¹é‡å¯¼å…¥</button>
            <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleImport(this)">
            <a href="/api/assets/export_csv/" class="btn btn-secondary btn-sm" target="_blank">ğŸ“Š å¯¼å‡ºå°è´¦</a>
            <button class="btn btn-success btn-sm" onclick="loadAssets()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="btn btn-primary btn-sm" onclick="showAddModal()">â• æ–°å¢è®¾å¤‡</button>
        </div>
        
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="search-section">
            <input type="text" id="searchInput" class="form-input" placeholder="æœç´¢è®¾å¤‡ç¼–ç ã€åç§°..." style="flex: 1;">
            <select id="statusFilter" class="form-select">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="active">è¿è¡Œä¸­</option>
                <option value="inactive">åœæœº</option>
                <option value="maintenance">ä¿å…»ä¸­</option>
                <option value="retired">æŠ¥åºŸ</option>
            </select>
            <button class="btn btn-primary" onclick="searchAssets()">æœç´¢</button>
        </div>
        
        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="messageArea"></div>
        
        <!-- è®¾å¤‡åˆ—è¡¨ -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>è®¾å¤‡ç¼–ç </th>
                        <th>è®¾å¤‡åç§°</th>
                        <th>ä½ç½®</th>
                        <th>ä¾›åº”å•†</th>
                        <th>çŠ¶æ€</th>
                        <th>å¯ç”¨æ—¥æœŸ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="assetsTable">
                    <tr><td colspan="7" style="text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_BASE = '/api';
        let allAssets = [];
        
        // è·å–è®¤è¯å¤´
        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageArea.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // å¤„ç†æ‰¹é‡å¯¼å…¥
        async function handleImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            showMessage('æ­£åœ¨å¯¼å…¥æ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/assets/import_excel/`, {
                    method: 'POST',
                    headers: {
                        ...(localStorage.getItem('access_token') && { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` })
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success_count > 0) {
                    showMessage(`å¯¼å…¥æˆåŠŸï¼æˆåŠŸå¯¼å…¥ ${result.success_count} æ¡è®°å½•${result.error_count > 0 ? `ï¼Œå¤±è´¥ ${result.error_count} æ¡` : ''}`, 'success');
                    loadAssets(); // é‡æ–°åŠ è½½æ•°æ®
                    
                    if (result.errors && result.errors.length > 0) {
                        setTimeout(() => {
                            alert('éƒ¨åˆ†è®°å½•å¯¼å…¥å¤±è´¥ï¼š\n\n' + result.errors.slice(0, 10).join('\n') + (result.errors.length > 10 ? '\n...' : ''));
                        }, 500);
                    }
                } else {
                    showMessage(result.message || 'å¯¼å…¥å¤±è´¥', 'error');
                    if (result.errors && result.errors.length > 0) {
                        setTimeout(() => {
                            alert('å¯¼å…¥å¤±è´¥ï¼š\n\n' + result.errors.slice(0, 10).join('\n'));
                        }, 500);
                    }
                }
                
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showMessage(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
            }
            
            // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            input.value = '';
        }
        
        // åŠ è½½è®¾å¤‡æ•°æ®
        async function loadAssets() {
            try {
                const response = await fetch(`${API_BASE}/assets/`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                allAssets = data.results || [];
                renderAssets(allAssets);
                
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡æ•°æ®å¤±è´¥:', error);
                document.getElementById('assetsTable').innerHTML = 
                    `<tr><td colspan="7" style="text-align: center; color: red; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            }
        }
        
        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
        function renderAssets(assets) {
            const tbody = document.getElementById('assetsTable');
            
            if (!assets || assets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">æš‚æ— è®¾å¤‡æ•°æ®</td></tr>';
                return;
            }
            
            tbody.innerHTML = assets.map(asset => `
                <tr>
                    <td>${asset.code || '-'}</td>
                    <td>${asset.name || '-'}</td>
                    <td>${getLocationDisplay(asset)}</td>
                    <td>${asset.vendor || '-'}</td>
                    <td>${getStatusBadge(asset.status)}</td>
                    <td>${formatDate(asset.start_date)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewAsset(${asset.id})">æŸ¥çœ‹</button>
                        <button class="btn btn-secondary btn-sm" onclick="editAsset(${asset.id})">ç¼–è¾‘</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // è·å–ä½ç½®æ˜¾ç¤º
        function getLocationDisplay(asset) {
            const parts = [asset.factory, asset.workshop, asset.line, asset.station].filter(p => p);
            return parts.length > 0 ? parts.join(' / ') : '-';
        }
        
        // è·å–çŠ¶æ€æ ‡ç­¾
        function getStatusBadge(status) {
            const badges = {
                'active': '<span class="status-badge status-active">è¿è¡Œä¸­</span>',
                'inactive': '<span class="status-badge status-inactive">åœæœº</span>',
                'maintenance': '<span class="status-badge status-maintenance">ä¿å…»ä¸­</span>',
                'retired': '<span class="status-badge status-retired">æŠ¥åºŸ</span>'
            };
            return badges[status] || `<span class="status-badge">${status || '-'}</span>`;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                return new Date(dateStr).toLocaleDateString('zh-CN');
            } catch (e) {
                return dateStr;
            }
        }
        
        // æœç´¢è®¾å¤‡
        function searchAssets() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = allAssets;
            
            if (searchTerm) {
                filtered = filtered.filter(asset => 
                    (asset.code && asset.code.toLowerCase().includes(searchTerm)) ||
                    (asset.name && asset.name.toLowerCase().includes(searchTerm))
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(asset => asset.status === statusFilter);
            }
            
            renderAssets(filtered);
        }
        
        // æŸ¥çœ‹è®¾å¤‡è¯¦æƒ…
        function viewAsset(id) {
            const asset = allAssets.find(a => a.id === id);
            if (asset) {
                alert(`è®¾å¤‡è¯¦æƒ…ï¼š\nç¼–ç ï¼š${asset.code}\nåç§°ï¼š${asset.name}\nçŠ¶æ€ï¼š${asset.status}\nä½ç½®ï¼š${getLocationDisplay(asset)}`);
            }
        }
        
        // ç¼–è¾‘è®¾å¤‡
        function editAsset(id) {
            showMessage('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        
        // æ˜¾ç¤ºæ–°å¢æ¨¡æ€æ¡†
        function showAddModal() {
            showMessage('æ–°å¢åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadAssets();
        });
    </script>
</body>
</html>