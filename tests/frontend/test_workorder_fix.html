<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å•ç®¡ç†ä¿®å¤æµ‹è¯•</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .test-container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .test-section { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .info { border-color: #3b82f6; background: #eff6ff; }
        .btn { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ å·¥å•ç®¡ç†ä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>æµ‹è¯•å·¥å•ç®¡ç†åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯APIè·¯å¾„ä¿®å¤åçš„ç”¨æˆ·åˆ—è¡¨åŠ è½½ã€‚</p>
        </div>

        <div class="test-section">
            <h3>ğŸ” æ­¥éª¤ 1: ç™»å½•</h3>
            <button class="btn btn-primary" onclick="testLogin()">ç™»å½•</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¥ æ­¥éª¤ 2: æµ‹è¯•ç”¨æˆ·åˆ—è¡¨API</h3>
            <button class="btn btn-success" onclick="testUsersAPI()">æµ‹è¯•ç”¨æˆ·åˆ—è¡¨</button>
            <div id="usersResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“„ æ­¥éª¤ 3: æµ‹è¯•å·¥å•é¡µé¢åŠ è½½</h3>
            <button class="btn btn-warning" onclick="testWorkOrderPage()">æµ‹è¯•å·¥å•é¡µé¢</button>
            <div id="pageResult"></div>
        </div>

        <div class="test-section">
            <h3>â• æ­¥éª¤ 4: æµ‹è¯•åˆ›å»ºå·¥å•æ¨¡æ€æ¡†</h3>
            <button class="btn btn-warning" onclick="testCreateModal()">æµ‹è¯•åˆ›å»ºæ¨¡æ€æ¡†</button>
            <div id="modalResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div id="currentStatus">
                <p><strong>ç™»å½•çŠ¶æ€:</strong> <span id="loginStatus">æœªç™»å½•</span></p>
                <p><strong>ç”¨æˆ·æ•°é‡:</strong> <span id="userCount">0</span> ä¸ª</p>
                <p><strong>è®¾å¤‡æ•°é‡:</strong> <span id="assetCount">0</span> ä¸ª</p>
            </div>
        </div>

        <!-- éšè—çš„é¡µé¢å®¹å™¨ -->
        <div id="page-workorders" style="display: none;"></div>
    </div>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/workorders.js"></script>
    <script src="/static/js/index.js"></script>

    <script>
        let authToken = null;
        let users = [];
        let assets = [];

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML = `<div class="test-section ${className}" style="margin-top: 10px;">${message}</div>`;
        }

        function updateStatus() {
            const token = localStorage.getItem('access_token');
            document.getElementById('loginStatus').textContent = token ? 'å·²ç™»å½•' : 'æœªç™»å½•';
            document.getElementById('userCount').textContent = users.length;
            document.getElementById('assetCount').textContent = assets.length;
        }

        async function testLogin() {
            updateResult('loginResult', 'ğŸ”„ æ­£åœ¨ç™»å½•...', 'info');
            
            try {
                const response = await fetch('/api/auth/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access;
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    updateResult('loginResult', `âœ… ç™»å½•æˆåŠŸï¼<br>ç”¨æˆ·: ${data.user.username}<br>è§’è‰²: ${data.user.role}`, 'success');
                    updateStatus();
                } else {
                    const error = await response.json();
                    updateResult('loginResult', `âŒ ç™»å½•å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                updateResult('loginResult', `âŒ ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testUsersAPI() {
            if (!authToken) {
                updateResult('usersResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            updateResult('usersResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•ç”¨æˆ·API...', 'info');

            try {
                // æµ‹è¯•ä¿®å¤åçš„APIè°ƒç”¨
                console.log('æµ‹è¯•APIè°ƒç”¨: /auth/users/');
                const response = await API.get('/auth/users/', { page_size: 1000 });
                
                users = response.results || [];
                updateResult('usersResult', `âœ… ç”¨æˆ·APIæµ‹è¯•æˆåŠŸï¼<br>è·å–åˆ° ${users.length} ä¸ªç”¨æˆ·`, 'success');
                updateStatus();

                // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
                if (users.length > 0) {
                    const userList = users.slice(0, 5).map(user => 
                        `â€¢ ${user.full_name || user.username} (${user.role_display || user.role})`
                    ).join('<br>');
                    updateResult('usersResult', `âœ… ç”¨æˆ·APIæµ‹è¯•æˆåŠŸï¼<br>è·å–åˆ° ${users.length} ä¸ªç”¨æˆ·<br><br>å‰5ä¸ªç”¨æˆ·:<br>${userList}`, 'success');
                }

            } catch (error) {
                updateResult('usersResult', `âŒ ç”¨æˆ·APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('ç”¨æˆ·APIæµ‹è¯•é”™è¯¯:', error);
            }
        }

        async function testWorkOrderPage() {
            if (!authToken) {
                updateResult('pageResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            updateResult('pageResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•å·¥å•é¡µé¢...', 'info');

            try {
                // æµ‹è¯•loadWorkOrderså‡½æ•°
                if (typeof loadWorkOrders === 'function') {
                    await loadWorkOrders();
                    updateResult('pageResult', 'âœ… å·¥å•é¡µé¢åŠ è½½æˆåŠŸï¼<br>é¡µé¢HTMLå·²ç”Ÿæˆ', 'success');
                } else {
                    updateResult('pageResult', 'âŒ loadWorkOrderså‡½æ•°ä¸å­˜åœ¨', 'error');
                }
            } catch (error) {
                updateResult('pageResult', `âŒ å·¥å•é¡µé¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('å·¥å•é¡µé¢æµ‹è¯•é”™è¯¯:', error);
            }
        }

        async function testCreateModal() {
            if (!authToken) {
                updateResult('modalResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            updateResult('modalResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•åˆ›å»ºæ¨¡æ€æ¡†...', 'info');

            try {
                // æµ‹è¯•showWorkOrderModalå‡½æ•°
                if (typeof showWorkOrderModal === 'function') {
                    await showWorkOrderModal();
                    updateResult('modalResult', 'âœ… åˆ›å»ºæ¨¡æ€æ¡†æµ‹è¯•æˆåŠŸï¼<br>æ¨¡æ€æ¡†å·²æ˜¾ç¤ºï¼Œç”¨æˆ·å’Œè®¾å¤‡åˆ—è¡¨å·²åŠ è½½', 'success');
                } else {
                    updateResult('modalResult', 'âŒ showWorkOrderModalå‡½æ•°ä¸å­˜åœ¨', 'error');
                }
            } catch (error) {
                updateResult('modalResult', `âŒ åˆ›å»ºæ¨¡æ€æ¡†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('åˆ›å»ºæ¨¡æ€æ¡†æµ‹è¯•é”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            updateStatus();
            console.log('ğŸš€ å·¥å•ç®¡ç†ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });

        // é”™è¯¯æ•è·
        window.addEventListener('error', function(e) {
            console.error('âŒ JavaScripté”™è¯¯:', e.message);
        });
    </script>
</body>
</html>