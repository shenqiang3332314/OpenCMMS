<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿å…»è®¡åˆ’æœ€ç»ˆæµ‹è¯•</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .test-container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        .test-section { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .info { border-color: #3b82f6; background: #eff6ff; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        .btn { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ ä¿å…»è®¡åˆ’ç³»ç»Ÿæœ€ç»ˆæµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™ä¸ªæµ‹è¯•å°†éªŒè¯ä¿å…»è®¡åˆ’ç³»ç»Ÿçš„å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬å‰ç«¯ç•Œé¢å’Œåç«¯APIçš„é›†æˆã€‚</p>
        </div>

        <div class="test-section">
            <h3>ğŸ” æ­¥éª¤ 1: ç”¨æˆ·è®¤è¯</h3>
            <button class="btn btn-primary" onclick="testLogin()">ç™»å½•ç³»ç»Ÿ</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“„ æ­¥éª¤ 2: é¡µé¢åŠ è½½æµ‹è¯•</h3>
            <button class="btn btn-success" onclick="testPageLoad()">æµ‹è¯•é¡µé¢åŠ è½½</button>
            <div id="pageResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ­¥éª¤ 3: ä¿å…»è®¡åˆ’CRUDæ“ä½œ</h3>
            <button class="btn btn-warning" onclick="testCRUDOperations()">æµ‹è¯•CRUDæ“ä½œ</button>
            <div id="crudResult"></div>
        </div>

        <div class="test-section">
            <h3>âš™ï¸ æ­¥éª¤ 4: é«˜çº§åŠŸèƒ½æµ‹è¯•</h3>
            <button class="btn btn-danger" onclick="testAdvancedFeatures()">æµ‹è¯•é«˜çº§åŠŸèƒ½</button>
            <div id="advancedResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div class="status-grid">
                <div>
                    <strong>ç™»å½•çŠ¶æ€:</strong> <span id="loginStatus">æœªç™»å½•</span><br>
                    <strong>ç”¨æˆ·ä¿¡æ¯:</strong> <span id="userInfo">-</span><br>
                    <strong>å¯ç”¨è®¾å¤‡:</strong> <span id="assetCount">0</span> ä¸ª
                </div>
                <div>
                    <strong>ä¿å…»è®¡åˆ’æ•°:</strong> <span id="planCount">0</span> ä¸ª<br>
                    <strong>æµ‹è¯•çŠ¶æ€:</strong> <span id="testStatus">å‡†å¤‡ä¸­</span><br>
                    <strong>æœ€åæ“ä½œ:</strong> <span id="lastAction">-</span>
                </div>
            </div>
        </div>

        <!-- éšè—çš„é¡µé¢å®¹å™¨ -->
        <div id="page-maintenance" style="display: none;"></div>
    </div>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/maintenance.js"></script>
    <script src="/static/js/index.js"></script>

    <script>
        let authToken = null;
        let availableAssets = [];
        let testPlanId = null;

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML = `<div class="test-section ${className}" style="margin-top: 10px;">${message}</div>`;
        }

        function updateStatus() {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');
            
            document.getElementById('loginStatus').textContent = token ? 'å·²ç™»å½•' : 'æœªç™»å½•';
            document.getElementById('assetCount').textContent = availableAssets.length;
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    document.getElementById('userInfo').textContent = `${userData.username} (${userData.role})`;
                } catch (e) {
                    document.getElementById('userInfo').textContent = 'è§£æé”™è¯¯';
                }
            }
        }

        async function testLogin() {
            updateResult('loginResult', 'ğŸ”„ æ­£åœ¨ç™»å½•...', 'info');
            document.getElementById('lastAction').textContent = 'ç™»å½•æµ‹è¯•';
            
            try {
                const response = await fetch('/api/auth/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access;
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    updateResult('loginResult', `âœ… ç™»å½•æˆåŠŸï¼<br>ç”¨æˆ·: ${data.user.username}<br>è§’è‰²: ${data.user.role}`, 'success');
                    
                    // åŠ è½½è®¾å¤‡åˆ—è¡¨
                    await loadAssets();
                    updateStatus();
                } else {
                    const error = await response.json();
                    updateResult('loginResult', `âŒ ç™»å½•å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                updateResult('loginResult', `âŒ ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function loadAssets() {
            try {
                const response = await fetch('/api/assets/', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    availableAssets = data.results || [];
                    console.log('âœ… åŠ è½½è®¾å¤‡åˆ—è¡¨:', availableAssets.length, 'ä¸ªè®¾å¤‡');
                } else {
                    console.error('âŒ åŠ è½½è®¾å¤‡å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½è®¾å¤‡å¼‚å¸¸:', error);
            }
        }

        async function testPageLoad() {
            if (!authToken) {
                updateResult('pageResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            updateResult('pageResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•é¡µé¢åŠ è½½...', 'info');
            document.getElementById('lastAction').textContent = 'é¡µé¢åŠ è½½æµ‹è¯•';

            try {
                // æµ‹è¯•å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
                const functions = ['loadMaintenance', 'loadMaintenancePlans', 'showMaintenancePlanModal', 'API'];
                const missing = [];
                
                functions.forEach(funcName => {
                    if (typeof window[funcName] === 'undefined') {
                        missing.push(funcName);
                    }
                });

                if (missing.length > 0) {
                    updateResult('pageResult', `âŒ ç¼ºå°‘å‡½æ•°: ${missing.join(', ')}`, 'error');
                    return;
                }

                // æµ‹è¯•loadMaintenanceå‡½æ•°
                await loadMaintenance();
                
                // æµ‹è¯•loadMaintenancePlanså‡½æ•°
                await loadMaintenancePlans();
                
                updateResult('pageResult', 'âœ… é¡µé¢åŠ è½½æµ‹è¯•æˆåŠŸï¼<br>æ‰€æœ‰å…³é”®å‡½æ•°éƒ½å­˜åœ¨ä¸”å¯æ­£å¸¸æ‰§è¡Œ', 'success');
                
            } catch (error) {
                updateResult('pageResult', `âŒ é¡µé¢åŠ è½½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('é¡µé¢åŠ è½½æµ‹è¯•é”™è¯¯:', error);
            }
        }

        async function testCRUDOperations() {
            if (!authToken) {
                updateResult('crudResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            if (availableAssets.length === 0) {
                updateResult('crudResult', 'âŒ æ²¡æœ‰å¯ç”¨è®¾å¤‡', 'error');
                return;
            }

            updateResult('crudResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•CRUDæ“ä½œ...', 'info');
            document.getElementById('lastAction').textContent = 'CRUDæ“ä½œæµ‹è¯•';

            try {
                // 1. åˆ›å»ºä¿å…»è®¡åˆ’
                const planData = {
                    code: 'TEST-' + Date.now(),
                    equipment: availableAssets[0].id,
                    title: 'å‰ç«¯æµ‹è¯•ä¿å…»è®¡åˆ’',
                    description: 'è¿™æ˜¯ä¸€ä¸ªå‰ç«¯CRUDæµ‹è¯•ä¿å…»è®¡åˆ’',
                    trigger_type: 'time',
                    frequency_value: 30,
                    frequency_unit: 'day',
                    priority: 'medium',
                    estimated_hours: 2.0,
                    estimated_cost: 100.00,
                    required_skills: 'æœºæ¢°å¸ˆ',
                    checklist_template: ['æ£€æŸ¥æœºæ²¹', 'æ£€æŸ¥çš®å¸¦', 'æ¸…æ´æ»¤ç½‘'],
                    is_active: true
                };

                const createResponse = await fetch('/api/maintenance/plans/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });

                if (!createResponse.ok) {
                    throw new Error(`åˆ›å»ºå¤±è´¥: ${createResponse.status}`);
                }

                const createdPlan = await createResponse.json();
                testPlanId = createdPlan.id;

                // 2. è¯»å–ä¿å…»è®¡åˆ’
                const readResponse = await fetch(`/api/maintenance/plans/${testPlanId}/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!readResponse.ok) {
                    throw new Error(`è¯»å–å¤±è´¥: ${readResponse.status}`);
                }

                // 3. æ›´æ–°ä¿å…»è®¡åˆ’
                const updateData = { ...planData, title: 'æ›´æ–°åçš„æµ‹è¯•ä¿å…»è®¡åˆ’' };
                const updateResponse = await fetch(`/api/maintenance/plans/${testPlanId}/`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!updateResponse.ok) {
                    throw new Error(`æ›´æ–°å¤±è´¥: ${updateResponse.status}`);
                }

                // 4. æµ‹è¯•loadMaintenancePlanså‡½æ•°
                await loadMaintenancePlans();

                updateResult('crudResult', `âœ… CRUDæ“ä½œæµ‹è¯•æˆåŠŸï¼<br>âœ“ åˆ›å»º: ${createdPlan.code}<br>âœ“ è¯»å–: æˆåŠŸ<br>âœ“ æ›´æ–°: æˆåŠŸ<br>âœ“ åˆ—è¡¨åˆ·æ–°: æˆåŠŸ`, 'success');

                // æ›´æ–°è®¡åˆ’æ•°é‡
                const listResponse = await fetch('/api/maintenance/plans/', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (listResponse.ok) {
                    const listData = await listResponse.json();
                    document.getElementById('planCount').textContent = listData.count || 0;
                }

            } catch (error) {
                updateResult('crudResult', `âŒ CRUDæ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('CRUDæµ‹è¯•é”™è¯¯:', error);
            }
        }

        async function testAdvancedFeatures() {
            if (!authToken || !testPlanId) {
                updateResult('advancedResult', 'âŒ è¯·å…ˆå®ŒæˆCRUDæµ‹è¯•', 'error');
                return;
            }

            updateResult('advancedResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•é«˜çº§åŠŸèƒ½...', 'info');
            document.getElementById('lastAction').textContent = 'é«˜çº§åŠŸèƒ½æµ‹è¯•';

            try {
                let results = [];

                // 1. æµ‹è¯•ç”Ÿæˆå·¥å•
                const generateResponse = await fetch(`/api/maintenance/plans/${testPlanId}/generate_work_order/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (generateResponse.ok) {
                    const generateResult = await generateResponse.json();
                    results.push(`âœ“ ç”Ÿæˆå·¥å•: ${generateResult.wo_code}`);
                } else {
                    results.push(`âœ— ç”Ÿæˆå·¥å•å¤±è´¥: ${generateResponse.status}`);
                }

                // 2. æµ‹è¯•åœç”¨è®¡åˆ’
                const deactivateResponse = await fetch(`/api/maintenance/plans/${testPlanId}/deactivate/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (deactivateResponse.ok) {
                    results.push('âœ“ åœç”¨è®¡åˆ’: æˆåŠŸ');
                } else {
                    results.push(`âœ— åœç”¨è®¡åˆ’å¤±è´¥: ${deactivateResponse.status}`);
                }

                // 3. æµ‹è¯•æ¿€æ´»è®¡åˆ’
                const activateResponse = await fetch(`/api/maintenance/plans/${testPlanId}/activate/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (activateResponse.ok) {
                    results.push('âœ“ æ¿€æ´»è®¡åˆ’: æˆåŠŸ');
                } else {
                    results.push(`âœ— æ¿€æ´»è®¡åˆ’å¤±è´¥: ${activateResponse.status}`);
                }

                // 4. æµ‹è¯•åˆ é™¤è®¡åˆ’
                const deleteResponse = await fetch(`/api/maintenance/plans/${testPlanId}/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (deleteResponse.ok) {
                    results.push('âœ“ åˆ é™¤è®¡åˆ’: æˆåŠŸ');
                    testPlanId = null;
                } else {
                    results.push(`âœ— åˆ é™¤è®¡åˆ’å¤±è´¥: ${deleteResponse.status}`);
                }

                // 5. åˆ·æ–°åˆ—è¡¨
                await loadMaintenancePlans();
                results.push('âœ“ åˆ—è¡¨åˆ·æ–°: æˆåŠŸ');

                updateResult('advancedResult', `âœ… é«˜çº§åŠŸèƒ½æµ‹è¯•å®Œæˆï¼<br>${results.join('<br>')}`, 'success');
                document.getElementById('testStatus').textContent = 'æµ‹è¯•å®Œæˆ';

            } catch (error) {
                updateResult('advancedResult', `âŒ é«˜çº§åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('é«˜çº§åŠŸèƒ½æµ‹è¯•é”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            updateStatus();
            console.log('ğŸš€ ä¿å…»è®¡åˆ’æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });

        // é”™è¯¯æ•è·
        window.addEventListener('error', function(e) {
            console.error('âŒ JavaScripté”™è¯¯:', e.message);
            document.getElementById('testStatus').textContent = 'å‘ç”Ÿé”™è¯¯';
        });
    </script>
</body>
</html>