<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿å…»è®¡åˆ’å‰ç«¯ç”Ÿæˆå·¥å•æµ‹è¯•</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .test-container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .test-section { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .info { border-color: #3b82f6; background: #eff6ff; }
        .btn { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ ä¿å…»è®¡åˆ’å‰ç«¯ç”Ÿæˆå·¥å•æµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>æµ‹è¯•ä¿å…»è®¡åˆ’å‰ç«¯ç”Ÿæˆå·¥å•åŠŸèƒ½ï¼ŒéªŒè¯ä¿®å¤åçš„APIè°ƒç”¨æ˜¯å¦æ­£å¸¸ã€‚</p>
        </div>

        <div class="test-section">
            <h3>ğŸ” æ­¥éª¤ 1: ç™»å½•</h3>
            <button class="btn btn-primary" onclick="testLogin()">ç™»å½•</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ­¥éª¤ 2: åŠ è½½ä¿å…»è®¡åˆ’</h3>
            <button class="btn btn-success" onclick="testLoadPlans()">åŠ è½½ä¿å…»è®¡åˆ’</button>
            <div id="plansResult"></div>
        </div>

        <div class="test-section">
            <h3>â• æ­¥éª¤ 3: åˆ›å»ºæµ‹è¯•ä¿å…»è®¡åˆ’</h3>
            <button class="btn btn-warning" onclick="testCreatePlan()">åˆ›å»ºæµ‹è¯•è®¡åˆ’</button>
            <div id="createResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ æ­¥éª¤ 4: ç”Ÿæˆå·¥å•</h3>
            <button class="btn btn-danger" onclick="testGenerateWorkOrder()">ç”Ÿæˆå·¥å•</button>
            <div id="generateResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ—‘ï¸ æ­¥éª¤ 5: æ¸…ç†æµ‹è¯•æ•°æ®</h3>
            <button class="btn btn-danger" onclick="cleanupTestData()">æ¸…ç†æ•°æ®</button>
            <div id="cleanupResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div id="currentStatus">
                <p><strong>ç™»å½•çŠ¶æ€:</strong> <span id="loginStatus">æœªç™»å½•</span></p>
                <p><strong>ä¿å…»è®¡åˆ’æ•°:</strong> <span id="planCount">0</span> ä¸ª</p>
                <p><strong>æµ‹è¯•è®¡åˆ’ID:</strong> <span id="testPlanId">-</span></p>
                <p><strong>ç”Ÿæˆçš„å·¥å•:</strong> <span id="generatedWO">-</span></p>
            </div>
        </div>

        <!-- éšè—çš„é¡µé¢å®¹å™¨ -->
        <div id="page-maintenance" style="display: none;"></div>
    </div>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/maintenance.js"></script>
    <script src="/static/js/index.js"></script>

    <script>
        let authToken = null;
        let testPlanId = null;
        let availableAssets = [];

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML = `<div class="test-section ${className}" style="margin-top: 10px;">${message}</div>`;
        }

        function updateStatus() {
            const token = localStorage.getItem('access_token');
            document.getElementById('loginStatus').textContent = token ? 'å·²ç™»å½•' : 'æœªç™»å½•';
            document.getElementById('testPlanId').textContent = testPlanId || '-';
        }

        async function testLogin() {
            updateResult('loginResult', 'ğŸ”„ æ­£åœ¨ç™»å½•...', 'info');
            
            try {
                const response = await fetch('/api/auth/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access;
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    updateResult('loginResult', `âœ… ç™»å½•æˆåŠŸï¼<br>ç”¨æˆ·: ${data.user.username}<br>è§’è‰²: ${data.user.role}`, 'success');
                    updateStatus();

                    // åŠ è½½è®¾å¤‡åˆ—è¡¨
                    await loadAssets();
                } else {
                    const error = await response.json();
                    updateResult('loginResult', `âŒ ç™»å½•å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                updateResult('loginResult', `âŒ ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function loadAssets() {
            try {
                const response = await API.getAssets({ page_size: 1000 });
                availableAssets = response.results || [];
                console.log('âœ… åŠ è½½è®¾å¤‡åˆ—è¡¨:', availableAssets.length, 'ä¸ªè®¾å¤‡');
            } catch (error) {
                console.error('âŒ åŠ è½½è®¾å¤‡å¤±è´¥:', error);
            }
        }

        async function testLoadPlans() {
            if (!authToken) {
                updateResult('plansResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            updateResult('plansResult', 'ğŸ”„ æ­£åœ¨åŠ è½½ä¿å…»è®¡åˆ’...', 'info');

            try {
                const response = await API.getMaintenancePlans({ page_size: 100 });
                const plans = response.results || [];
                
                document.getElementById('planCount').textContent = plans.length;
                
                let plansList = '';
                if (plans.length > 0) {
                    plansList = '<br><strong>ç°æœ‰è®¡åˆ’:</strong><br>';
                    plans.slice(0, 5).forEach(plan => {
                        plansList += `â€¢ ${plan.code}: ${plan.title} (${plan.is_active ? 'å¯ç”¨' : 'åœç”¨'})<br>`;
                    });
                }
                
                updateResult('plansResult', `âœ… ä¿å…»è®¡åˆ’åŠ è½½æˆåŠŸï¼<br>è·å–åˆ° ${plans.length} ä¸ªä¿å…»è®¡åˆ’${plansList}`, 'success');
            } catch (error) {
                updateResult('plansResult', `âŒ åŠ è½½ä¿å…»è®¡åˆ’å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testCreatePlan() {
            if (!authToken) {
                updateResult('createResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            if (availableAssets.length === 0) {
                updateResult('createResult', 'âŒ æ²¡æœ‰å¯ç”¨è®¾å¤‡', 'error');
                return;
            }

            updateResult('createResult', 'ğŸ”„ æ­£åœ¨åˆ›å»ºæµ‹è¯•ä¿å…»è®¡åˆ’...', 'info');

            const planData = {
                code: 'FRONTEND-TEST-' + Date.now(),
                equipment: availableAssets[0].id,
                title: 'å‰ç«¯æµ‹è¯•ä¿å…»è®¡åˆ’-ç”Ÿæˆå·¥å•',
                description: 'è¿™æ˜¯ä¸€ä¸ªå‰ç«¯æµ‹è¯•ä¿å…»è®¡åˆ’ï¼Œç”¨äºæµ‹è¯•ç”Ÿæˆå·¥å•åŠŸèƒ½',
                trigger_type: 'time',
                frequency_value: 30,
                frequency_unit: 'day',
                priority: 'medium',
                estimated_hours: 2.0,
                estimated_cost: 100.00,
                required_skills: 'æœºæ¢°å¸ˆ',
                checklist_template: ['æ£€æŸ¥æœºæ²¹', 'æ£€æŸ¥çš®å¸¦', 'æ¸…æ´æ»¤ç½‘'],
                is_active: true
            };

            try {
                const response = await API.createMaintenancePlan(planData);
                testPlanId = response.id;
                
                updateResult('createResult', `âœ… æµ‹è¯•ä¿å…»è®¡åˆ’åˆ›å»ºæˆåŠŸï¼<br>ç¼–å·: ${response.code}<br>ID: ${response.id}`, 'success');
                updateStatus();
            } catch (error) {
                updateResult('createResult', `âŒ åˆ›å»ºæµ‹è¯•ä¿å…»è®¡åˆ’å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGenerateWorkOrder() {
            if (!authToken) {
                updateResult('generateResult', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }

            if (!testPlanId) {
                updateResult('generateResult', 'âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¿å…»è®¡åˆ’', 'error');
                return;
            }

            updateResult('generateResult', 'ğŸ”„ æ­£åœ¨ç”Ÿæˆå·¥å•...', 'info');

            try {
                // ä½¿ç”¨API.postæ–¹æ³•è°ƒç”¨ç”Ÿæˆå·¥å•æ¥å£
                const response = await API.post(`/maintenance/plans/${testPlanId}/generate_work_order/`, {});
                
                document.getElementById('generatedWO').textContent = response.wo_code || 'Unknown';
                
                updateResult('generateResult', `âœ… å·¥å•ç”ŸæˆæˆåŠŸï¼<br>å·¥å•ç¼–å·: ${response.wo_code}<br>å·¥å•ID: ${response.work_order_id}<br>æ¶ˆæ¯: ${response.message}`, 'success');
                
                // éªŒè¯ç”Ÿæˆçš„å·¥å•
                if (response.work_order_id) {
                    try {
                        const woResponse = await API.getWorkOrder(response.work_order_id);
                        updateResult('generateResult', `âœ… å·¥å•ç”Ÿæˆå¹¶éªŒè¯æˆåŠŸï¼<br>å·¥å•ç¼–å·: ${response.wo_code}<br>æ‘˜è¦: ${woResponse.summary}<br>çŠ¶æ€: ${woResponse.status}<br>ç±»å‹: ${woResponse.wo_type}`, 'success');
                    } catch (verifyError) {
                        console.warn('å·¥å•éªŒè¯å¤±è´¥:', verifyError);
                    }
                }
                
            } catch (error) {
                updateResult('generateResult', `âŒ ç”Ÿæˆå·¥å•å¤±è´¥: ${error.message}`, 'error');
                console.error('ç”Ÿæˆå·¥å•é”™è¯¯è¯¦æƒ…:', error);
            }
        }

        async function cleanupTestData() {
            if (!testPlanId) {
                updateResult('cleanupResult', 'âš ï¸ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æµ‹è¯•æ•°æ®', 'info');
                return;
            }

            updateResult('cleanupResult', 'ğŸ”„ æ­£åœ¨æ¸…ç†æµ‹è¯•æ•°æ®...', 'info');

            try {
                await API.deleteMaintenancePlan(testPlanId);
                
                updateResult('cleanupResult', 'âœ… æµ‹è¯•æ•°æ®æ¸…ç†æˆåŠŸï¼', 'success');
                testPlanId = null;
                updateStatus();
            } catch (error) {
                updateResult('cleanupResult', `âŒ æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            updateStatus();
            console.log('ğŸš€ ä¿å…»è®¡åˆ’å‰ç«¯ç”Ÿæˆå·¥å•æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });

        // é”™è¯¯æ•è·
        window.addEventListener('error', function(e) {
            console.error('âŒ JavaScripté”™è¯¯:', e.message);
        });
    </script>
</body>
</html>