<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保养计划前端测试</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .test-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .info { border-color: #3b82f6; background: #eff6ff; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>保养计划前端功能测试</h1>
        
        <div class="test-section info">
            <h3>测试说明</h3>
            <p>这个页面将测试保养计划的前端功能，包括创建、编辑、激活/停用等操作</p>
        </div>

        <div class="test-section">
            <h3>步骤 1: 登录</h3>
            <button class="btn btn-primary" onclick="testLogin()">登录</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>步骤 2: 测试保养计划页面加载</h3>
            <button class="btn btn-success" onclick="testMaintenancePage()">测试保养计划页面</button>
            <div id="maintenanceResult"></div>
        </div>

        <div class="test-section">
            <h3>步骤 3: 创建保养计划</h3>
            <div class="form-grid">
                <div>
                    <label class="form-label">计划编号:</label>
                    <input type="text" id="planCode" class="form-input" value="MP-TEST-002">
                </div>
                <div>
                    <label class="form-label">标题:</label>
                    <input type="text" id="planTitle" class="form-input" value="前端测试保养计划">
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label class="form-label">描述:</label>
                <textarea id="planDescription" class="form-textarea" rows="2">这是一个前端测试保养计划</textarea>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn btn-primary" onclick="testCreatePlan()">创建保养计划</button>
            </div>
            <div id="createResult"></div>
        </div>

        <div class="test-section">
            <h3>步骤 4: 保养计划列表</h3>
            <button class="btn btn-info" onclick="loadMaintenancePlans()">加载保养计划列表</button>
            <div id="plansList"></div>
        </div>

        <div class="test-section">
            <h3>当前状态</h3>
            <div id="currentStatus"></div>
        </div>

        <!-- 隐藏的页面容器用于测试 -->
        <div id="page-maintenance" style="display: none;"></div>
    </div>

    <!-- 加载JavaScript文件 -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/maintenance.js"></script>
    <script src="/static/js/index.js"></script>

    <script>
        let authToken = null;
        let availableAssets = [];
        let createdPlanId = null;

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML = `<div class="test-section ${className}" style="margin-top: 10px;">${message}</div>`;
        }

        function showCurrentStatus() {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');
            
            let status = '<h4>当前状态:</h4>';
            status += `<p><strong>登录状态:</strong> ${token ? '已登录' : '未登录'}</p>`;
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    status += `<p><strong>用户:</strong> ${userData.username} (${userData.role})</p>`;
                } catch (e) {
                    status += `<p><strong>用户数据:</strong> 解析错误</p>`;
                }
            }

            if (createdPlanId) {
                status += `<p><strong>创建的计划ID:</strong> ${createdPlanId}</p>`;
            }

            document.getElementById('currentStatus').innerHTML = status;
        }

        async function testLogin() {
            updateResult('loginResult', '正在登录...', 'info');
            
            try {
                const response = await fetch('/api/auth/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access;
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    updateResult('loginResult', `✅ 登录成功！用户: ${data.user.username} (${data.user.role})`, 'success');
                    showCurrentStatus();

                    // 加载设备列表
                    await loadAssets();
                } else {
                    const error = await response.json();
                    updateResult('loginResult', `❌ 登录失败: ${error.detail || '未知错误'}`, 'error');
                }
            } catch (error) {
                updateResult('loginResult', `❌ 登录异常: ${error.message}`, 'error');
            }
        }

        async function loadAssets() {
            try {
                const response = await fetch('/api/assets/', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    availableAssets = data.results || [];
                    console.log('加载设备列表:', availableAssets.length, '个设备');
                } else {
                    console.error('加载设备失败');
                }
            } catch (error) {
                console.error('加载设备异常:', error);
            }
        }

        async function testMaintenancePage() {
            if (!authToken) {
                updateResult('maintenanceResult', '❌ 请先登录', 'error');
                return;
            }

            updateResult('maintenanceResult', '正在测试保养计划页面...', 'info');

            try {
                // 测试loadMaintenance函数
                if (typeof loadMaintenance === 'function') {
                    await loadMaintenance();
                    updateResult('maintenanceResult', '✅ 保养计划页面加载成功', 'success');

                    // 检查页面元素
                    const pageElement = document.getElementById('page-maintenance');
                    if (pageElement && pageElement.innerHTML.includes('保养计划')) {
                        updateResult('maintenanceResult', '✅ 保养计划页面HTML已生成，包含创建按钮和表格', 'success');
                    } else {
                        updateResult('maintenanceResult', '❌ 保养计划页面HTML未正确生成', 'error');
                    }
                } else {
                    updateResult('maintenanceResult', '❌ loadMaintenance函数不存在', 'error');
                }
            } catch (error) {
                updateResult('maintenanceResult', `❌ 测试异常: ${error.message}`, 'error');
            }
        }

        async function testCreatePlan() {
            if (!authToken) {
                updateResult('createResult', '❌ 请先登录', 'error');
                return;
            }

            if (availableAssets.length === 0) {
                updateResult('createResult', '❌ 没有可用设备', 'error');
                return;
            }

            const planData = {
                code: document.getElementById('planCode').value,
                equipment: availableAssets[0].id,
                title: document.getElementById('planTitle').value,
                description: document.getElementById('planDescription').value,
                trigger_type: 'time',
                frequency_value: 30,
                frequency_unit: 'day',
                priority: 'medium',
                estimated_hours: 2.0,
                estimated_cost: 100.00,
                required_skills: '机械师',
                checklist_template: ['检查机油', '检查皮带', '清洁滤网'],
                is_active: true
            };

            updateResult('createResult', '正在创建保养计划...', 'info');

            try {
                const response = await fetch('/api/maintenance/plans/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });

                if (response.ok) {
                    const result = await response.json();
                    createdPlanId = result.id;
                    updateResult('createResult', `✅ 保养计划创建成功！<br>编号: ${result.code}<br>ID: ${result.id}`, 'success');
                    showCurrentStatus();
                } else {
                    const error = await response.json();
                    updateResult('createResult', `❌ 创建失败: ${JSON.stringify(error)}`, 'error');
                }
            } catch (error) {
                updateResult('createResult', `❌ 创建异常: ${error.message}`, 'error');
            }
        }

        async function loadMaintenancePlans() {
            if (!authToken) {
                updateResult('plansList', '❌ 请先登录', 'error');
                return;
            }

            updateResult('plansList', '正在加载保养计划列表...', 'info');

            try {
                const response = await fetch('/api/maintenance/plans/', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const plans = data.results || [];
                    
                    let html = `<h4>保养计划列表 (${plans.length} 个)</h4>`;
                    
                    if (plans.length === 0) {
                        html += '<p>暂无保养计划</p>';
                    } else {
                        html += '<table class="table" style="width: 100%; margin-top: 10px;">';
                        html += '<thead><tr><th>编号</th><th>标题</th><th>设备</th><th>状态</th><th>操作</th></tr></thead>';
                        html += '<tbody>';
                        
                        plans.forEach(plan => {
                            html += `<tr>
                                <td>${plan.code}</td>
                                <td>${plan.title}</td>
                                <td>${plan.equipment_name || '-'}</td>
                                <td>${plan.is_active ? '启用' : '停用'}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="testGenerateWorkOrder(${plan.id})">生成工单</button>
                                    <button class="btn btn-sm btn-danger" onclick="testDeletePlan(${plan.id})">删除</button>
                                </td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table>';
                    }
                    
                    updateResult('plansList', html, 'success');
                } else {
                    updateResult('plansList', `❌ 加载失败: ${response.status}`, 'error');
                }
            } catch (error) {
                updateResult('plansList', `❌ 加载异常: ${error.message}`, 'error');
            }
        }

        async function testGenerateWorkOrder(planId) {
            try {
                const response = await fetch(`/api/maintenance/plans/${planId}/generate_work_order/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`✅ 工单生成成功: ${result.wo_code}`);
                    loadMaintenancePlans(); // 重新加载列表
                } else {
                    const error = await response.json();
                    alert(`❌ 生成工单失败: ${JSON.stringify(error)}`);
                }
            } catch (error) {
                alert(`❌ 生成工单异常: ${error.message}`);
            }
        }

        async function testDeletePlan(planId) {
            if (!confirm('确定要删除这个保养计划吗？')) return;

            try {
                const response = await fetch(`/api/maintenance/plans/${planId}/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    alert('✅ 保养计划删除成功');
                    loadMaintenancePlans(); // 重新加载列表
                } else {
                    alert(`❌ 删除失败: ${response.status}`);
                }
            } catch (error) {
                alert(`❌ 删除异常: ${error.message}`);
            }
        }

        // 页面加载完成后显示状态
        window.addEventListener('load', function() {
            showCurrentStatus();
            
            // 检查关键函数是否存在
            const functions = ['loadMaintenance', 'API'];
            functions.forEach(funcName => {
                if (typeof window[funcName] !== 'undefined') {
                    console.log(`✅ ${funcName}: 已定义`);
                } else {
                    console.log(`❌ ${funcName}: 未定义`);
                }
            });
        });

        // 捕获错误
        window.addEventListener('error', function(e) {
            console.error('JavaScript错误:', e.message);
        });
    </script>
</body>
</html>