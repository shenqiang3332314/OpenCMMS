<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­æ³•ä¿®å¤æµ‹è¯•</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .test-container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>JavaScriptè¯­æ³•ä¿®å¤æµ‹è¯•</h1>
        
        <div id="loadStatus" class="status info">æ­£åœ¨åŠ è½½JavaScriptæ–‡ä»¶...</div>
        
        <div class="card">
            <div class="card-header">
                <h3>æµ‹è¯•ç»“æœ</h3>
            </div>
            <div class="card-body">
                <div id="testResults"></div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="testMainInterface()">æµ‹è¯•ä¸»ç•Œé¢</button>
                    <button class="btn btn-success" onclick="testWithLogin()">ç™»å½•åæµ‹è¯•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒ‰æ­£ç¡®é¡ºåºåŠ è½½JavaScriptæ–‡ä»¶ -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/assets.js"></script>
    <script src="/static/js/workorders.js"></script>
    <script src="/static/js/maintenance.js"></script>
    <script src="/static/js/index.js"></script>

    <script>
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('loadStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const resultEl = document.createElement('div');
            resultEl.className = `status ${type}`;
            resultEl.textContent = message;
            resultsDiv.appendChild(resultEl);
        }

        function testMainInterface() {
            addResult('æµ‹è¯•ä¸»ç•Œé¢åŠŸèƒ½...', 'info');
            
            // æµ‹è¯•å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
            const functions = [
                'loadDashboard',
                'loadWorkOrders', 
                'loadAssets',
                'loadMaintenance',
                'showWorkOrderModal',
                'API'
            ];

            let allGood = true;
            functions.forEach(funcName => {
                if (typeof window[funcName] !== 'undefined') {
                    addResult(`âœ… ${funcName}: å·²å®šä¹‰`, 'success');
                } else {
                    addResult(`âŒ ${funcName}: æœªå®šä¹‰`, 'error');
                    allGood = false;
                }
            });

            if (allGood) {
                addResult('ğŸ‰ æ‰€æœ‰å…³é”®å‡½æ•°éƒ½å·²æ­£ç¡®å®šä¹‰ï¼', 'success');
                addResult('ç°åœ¨å¯ä»¥è®¿é—®ä¸»ç•Œé¢äº†ï¼šhttp://127.0.0.1:8000/static/index.html', 'info');
            } else {
                addResult('âŒ ä»æœ‰å‡½æ•°æœªå®šä¹‰ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥', 'error');
            }
        }

        async function testWithLogin() {
            addResult('æµ‹è¯•ç™»å½•æµç¨‹...', 'info');
            
            try {
                // æµ‹è¯•ç™»å½•
                const response = await fetch('/api/auth/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    addResult('âœ… ç™»å½•æˆåŠŸï¼', 'success');
                    addResult('ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ä¸»ç•Œé¢çš„æ‰€æœ‰åŠŸèƒ½äº†', 'success');
                    addResult('ç‚¹å‡»è¿™é‡Œè®¿é—®ï¼šhttp://127.0.0.1:8000/static/index.html', 'info');
                } else {
                    addResult('âŒ ç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                addResult(`âŒ ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„æ£€æŸ¥
        window.addEventListener('load', function() {
            updateStatus('âœ… JavaScriptæ–‡ä»¶åŠ è½½å®Œæˆï¼Œæ²¡æœ‰è¯­æ³•é”™è¯¯ï¼', 'success');
            addResult('JavaScriptè¯­æ³•é”™è¯¯å·²ä¿®å¤', 'success');
            addResult('æ‰€æœ‰æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œå¯ä»¥è¿›è¡ŒåŠŸèƒ½æµ‹è¯•', 'info');
        });

        // æ•è·JavaScripté”™è¯¯
        window.addEventListener('error', function(e) {
            updateStatus(`âŒ JavaScripté”™è¯¯: ${e.message}`, 'error');
            addResult(`é”™è¯¯è¯¦æƒ…: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });
    </script>
</body>
</html>