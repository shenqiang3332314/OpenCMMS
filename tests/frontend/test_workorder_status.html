<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工单状态管理测试</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .status-flow { display: flex; align-items: center; margin: 20px 0; }
        .status-step { 
            padding: 8px 16px; 
            background: #f3f4f6; 
            border-radius: 4px; 
            margin-right: 10px;
            font-size: 12px;
        }
        .status-step.active { background: #3b82f6; color: white; }
        .status-step.completed { background: #10b981; color: white; }
        .arrow { margin: 0 5px; color: #6b7280; }
        .workorder-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .actions { margin-top: 15px; }
        .actions button { margin-right: 10px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>工单状态管理测试</h1>
        
        <div class="login-section" id="loginSection">
            <div class="workorder-card">
                <h2>登录</h2>
                <div class="form-group">
                    <label class="form-label">用户名:</label>
                    <input type="text" id="username" class="form-input" value="admin">
                </div>
                <div class="form-group">
                    <label class="form-label">密码:</label>
                    <input type="password" id="password" class="form-input" value="admin123">
                </div>
                <button class="btn btn-primary" onclick="login()">登录</button>
            </div>
        </div>

        <div class="workorder-section" id="workorderSection" style="display: none;">
            <div class="workorder-card">
                <h2>工单状态流程</h2>
                <div class="status-flow">
                    <div class="status-step">待处理 (open)</div>
                    <span class="arrow">→</span>
                    <div class="status-step">已分配 (assigned)</div>
                    <span class="arrow">→</span>
                    <div class="status-step">进行中 (in_progress)</div>
                    <span class="arrow">→</span>
                    <div class="status-step">已完成 (completed)</div>
                    <span class="arrow">→</span>
                    <div class="status-step">已关闭 (closed)</div>
                </div>
                <p><strong>操作说明：</strong></p>
                <ul>
                    <li><strong>分配：</strong>将工单分配给技术人员</li>
                    <li><strong>开始：</strong>开始执行工单，记录开始时间</li>
                    <li><strong>完成：</strong>完成工单，需要填写处理措施</li>
                    <li><strong>关闭：</strong>最终关闭工单，不可再修改</li>
                </ul>
            </div>

            <div class="workorder-card">
                <h2>创建测试工单</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">设备:</label>
                        <select id="equipment" class="form-select">
                            <option value="">请选择设备</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">优先级:</label>
                        <select id="priority" class="form-select">
                            <option value="low">低</option>
                            <option value="medium">中</option>
                            <option value="high">高</option>
                            <option value="critical">紧急</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">摘要:</label>
                    <input type="text" id="summary" class="form-input" placeholder="请输入工单摘要">
                </div>
                <button class="btn btn-primary" onclick="createTestWorkOrder()">创建测试工单</button>
            </div>

            <div class="workorder-card">
                <h2>工单列表</h2>
                <div id="workordersList">
                    <p>加载中...</p>
                </div>
            </div>
        </div>

        <div id="messages"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let authToken = null;
        let availableAssets = [];
        let availableUsers = [];

        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message message-${type}`;
            messageEl.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                min-width: 250px; padding: 12px 16px; border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                background: ${type === 'success' ? '#d4edda' : '#f8d7da'};
                color: ${type === 'success' ? '#155724' : '#721c24'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};
            `;
            messageEl.textContent = message;
            messagesDiv.appendChild(messageEl);
            
            setTimeout(() => messageEl.remove(), 5000);
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access;
                    showMessage('登录成功', 'success');
                    
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('workorderSection').style.display = 'block';
                    
                    await loadData();
                } else {
                    const error = await response.json();
                    showMessage('登录失败: ' + (error.detail || '未知错误'), 'error');
                }
            } catch (error) {
                showMessage('登录失败: ' + error.message, 'error');
            }
        }

        async function loadData() {
            try {
                const [assetsRes, usersRes] = await Promise.all([
                    fetch(`${API_BASE}/assets/`, { headers: { 'Authorization': `Bearer ${authToken}` } }),
                    fetch(`${API_BASE}/auth/users/`, { headers: { 'Authorization': `Bearer ${authToken}` } })
                ]);

                if (assetsRes.ok && usersRes.ok) {
                    const assetsData = await assetsRes.json();
                    const usersData = await usersRes.json();
                    
                    availableAssets = assetsData.results || [];
                    availableUsers = usersData.results || [];

                    // 填充设备下拉列表
                    const equipmentSelect = document.getElementById('equipment');
                    availableAssets.forEach(asset => {
                        const option = document.createElement('option');
                        option.value = asset.id;
                        option.textContent = `${asset.code} - ${asset.name}`;
                        equipmentSelect.appendChild(option);
                    });

                    await loadWorkOrders();
                }
            } catch (error) {
                showMessage('加载数据失败: ' + error.message, 'error');
            }
        }

        async function createTestWorkOrder() {
            const equipment = document.getElementById('equipment').value;
            const priority = document.getElementById('priority').value;
            const summary = document.getElementById('summary').value;

            if (!equipment || !summary) {
                showMessage('请选择设备并填写摘要', 'error');
                return;
            }

            const data = {
                equipment: equipment,
                wo_type: 'CM',
                status: 'open',
                summary: summary,
                priority: priority,
                description: '这是一个测试工单，用于演示状态管理功能'
            };

            try {
                const response = await fetch(`${API_BASE}/workorders/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(`工单创建成功: ${result.wo_code}`, 'success');
                    document.getElementById('summary').value = '';
                    await loadWorkOrders();
                } else {
                    const error = await response.json();
                    showMessage('创建工单失败: ' + JSON.stringify(error), 'error');
                }
            } catch (error) {
                showMessage('创建工单失败: ' + error.message, 'error');
            }
        }

        async function loadWorkOrders() {
            try {
                const response = await fetch(`${API_BASE}/workorders/?ordering=-created_at`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderWorkOrders(data.results || []);
                }
            } catch (error) {
                showMessage('加载工单失败: ' + error.message, 'error');
            }
        }

        function renderWorkOrders(workorders) {
            const container = document.getElementById('workordersList');
            
            if (workorders.length === 0) {
                container.innerHTML = '<p>暂无工单</p>';
                return;
            }

            container.innerHTML = workorders.map(wo => `
                <div class="workorder-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3>${wo.wo_code} - ${wo.summary}</h3>
                            <p><strong>设备:</strong> ${wo.equipment_name || '-'}</p>
                            <p><strong>状态:</strong> ${getStatusDisplay(wo.status)}</p>
                            <p><strong>优先级:</strong> ${getPriorityDisplay(wo.priority)}</p>
                            <p><strong>负责人:</strong> ${wo.assignee_name || '未分配'}</p>
                            <p><strong>创建时间:</strong> ${new Date(wo.created_at).toLocaleString()}</p>
                        </div>
                        <div class="actions">
                            ${getActionButtons(wo)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusDisplay(status) {
            const statusMap = {
                'open': '待处理',
                'assigned': '已分配',
                'in_progress': '进行中',
                'completed': '已完成',
                'closed': '已关闭',
                'canceled': '已取消'
            };
            return statusMap[status] || status;
        }

        function getPriorityDisplay(priority) {
            const priorityMap = {
                'low': '低',
                'medium': '中',
                'high': '高',
                'critical': '紧急'
            };
            return priorityMap[priority] || priority;
        }

        function getActionButtons(wo) {
            let buttons = '';
            
            switch (wo.status) {
                case 'open':
                    if (!wo.assignee) {
                        buttons += `<button class="btn btn-info btn-sm" onclick="assignWorkOrder(${wo.id})">分配</button>`;
                    }
                    buttons += `<button class="btn btn-success btn-sm" onclick="startWorkOrder(${wo.id})">开始</button>`;
                    break;
                    
                case 'assigned':
                    buttons += `<button class="btn btn-success btn-sm" onclick="startWorkOrder(${wo.id})">开始</button>`;
                    break;
                    
                case 'in_progress':
                    buttons += `<button class="btn btn-warning btn-sm" onclick="completeWorkOrder(${wo.id})">完成</button>`;
                    break;
                    
                case 'completed':
                    buttons += `<button class="btn btn-dark btn-sm" onclick="closeWorkOrder(${wo.id})">关闭</button>`;
                    break;
            }
            
            return buttons;
        }

        async function assignWorkOrder(id) {
            const assigneeId = prompt('请输入负责人ID (可用ID: ' + availableUsers.map(u => `${u.id}:${u.username}`).join(', ') + ')');
            if (!assigneeId) return;

            try {
                const response = await fetch(`${API_BASE}/workorders/${id}/assign/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ assignee_id: parseInt(assigneeId) })
                });

                if (response.ok) {
                    showMessage('工单分配成功', 'success');
                    await loadWorkOrders();
                } else {
                    const error = await response.json();
                    showMessage('分配失败: ' + JSON.stringify(error), 'error');
                }
            } catch (error) {
                showMessage('分配失败: ' + error.message, 'error');
            }
        }

        async function startWorkOrder(id) {
            if (!confirm('确定要开始这个工单吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/workorders/${id}/start/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showMessage('工单已开始', 'success');
                    await loadWorkOrders();
                } else {
                    const error = await response.json();
                    showMessage('开始失败: ' + JSON.stringify(error), 'error');
                }
            } catch (error) {
                showMessage('开始失败: ' + error.message, 'error');
            }
        }

        async function completeWorkOrder(id) {
            const actionsTaken = prompt('请输入处理措施 (必填):');
            if (!actionsTaken) {
                showMessage('处理措施不能为空', 'error');
                return;
            }

            try {
                // 直接完成工单，传递完成数据
                const response = await fetch(`${API_BASE}/workorders/${id}/complete/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ actions_taken: actionsTaken })
                });

                if (response.ok) {
                    showMessage('工单已完成', 'success');
                    await loadWorkOrders();
                } else {
                    const error = await response.json();
                    showMessage('完成失败: ' + JSON.stringify(error), 'error');
                }
            } catch (error) {
                showMessage('完成失败: ' + error.message, 'error');
            }
        }

        async function closeWorkOrder(id) {
            if (!confirm('确定要关闭这个工单吗？关闭后将无法再修改。')) return;

            try {
                const response = await fetch(`${API_BASE}/workorders/${id}/close/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showMessage('工单已关闭', 'success');
                    await loadWorkOrders();
                } else {
                    const error = await response.json();
                    showMessage('关闭失败: ' + JSON.stringify(error), 'error');
                }
            } catch (error) {
                showMessage('关闭失败: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>