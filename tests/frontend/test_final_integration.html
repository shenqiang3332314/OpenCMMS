<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMMSç³»ç»Ÿæœ€ç»ˆé›†æˆæµ‹è¯•</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .test-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .test-section { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .info { border-color: #3b82f6; background: #eff6ff; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        .btn { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px; }
        .progress { width: 100%; height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #10b981; transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ­ CMMSç³»ç»Ÿæœ€ç»ˆé›†æˆæµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™æ˜¯CMMSç³»ç»Ÿçš„å®Œæ•´é›†æˆæµ‹è¯•ï¼Œå°†éªŒè¯å·¥å•ç®¡ç†ã€ä¿å…»è®¡åˆ’ã€è®¾å¤‡ç®¡ç†ç­‰æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ã€‚</p>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <p style="margin-top: 10px;"><strong>æµ‹è¯•è¿›åº¦:</strong> <span id="progressText">0/8 å®Œæˆ</span></p>
        </div>

        <div class="test-section">
            <h3>ğŸ” æ­¥éª¤ 1: ç”¨æˆ·è®¤è¯</h3>
            <button class="btn btn-primary" onclick="runTest(1, testLogin)">æµ‹è¯•ç™»å½•</button>
            <div id="test1Result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¥ æ­¥éª¤ 2: ç”¨æˆ·ç®¡ç†API</h3>
            <button class="btn btn-success" onclick="runTest(2, testUsersAPI)">æµ‹è¯•ç”¨æˆ·API</button>
            <div id="test2Result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ­ æ­¥éª¤ 3: è®¾å¤‡ç®¡ç†</h3>
            <button class="btn btn-success" onclick="runTest(3, testAssetsModule)">æµ‹è¯•è®¾å¤‡ç®¡ç†</button>
            <div id="test3Result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ­¥éª¤ 4: å·¥å•ç®¡ç†</h3>
            <button class="btn btn-warning" onclick="runTest(4, testWorkOrderModule)">æµ‹è¯•å·¥å•ç®¡ç†</button>
            <div id="test4Result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ æ­¥éª¤ 5: ä¿å…»è®¡åˆ’</h3>
            <button class="btn btn-warning" onclick="runTest(5, testMaintenanceModule)">æµ‹è¯•ä¿å…»è®¡åˆ’</button>
            <div id="test5Result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“¦ æ­¥éª¤ 6: å¤‡ä»¶ç®¡ç†</h3>
            <button class="btn btn-success" onclick="runTest(6, testSparePartsModule)">æµ‹è¯•å¤‡ä»¶ç®¡ç†</button>
            <div id="test6Result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ æ­¥éª¤ 7: å·¥å•æµç¨‹</h3>
            <button class="btn btn-danger" onclick="runTest(7, testWorkOrderFlow)">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <div id="test7Result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ§¹ æ­¥éª¤ 8: æ¸…ç†æµ‹è¯•æ•°æ®</h3>
            <button class="btn btn-danger" onclick="runTest(8, cleanupTestData)">æ¸…ç†æ•°æ®</button>
            <div id="test8Result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
            <div class="status-grid">
                <div>
                    <strong>ç™»å½•çŠ¶æ€:</strong> <span id="loginStatus">æœªç™»å½•</span><br>
                    <strong>ç”¨æˆ·ä¿¡æ¯:</strong> <span id="userInfo">-</span><br>
                    <strong>æµ‹è¯•çŠ¶æ€:</strong> <span id="testStatus">å‡†å¤‡ä¸­</span>
                </div>
                <div>
                    <strong>ç”¨æˆ·æ•°é‡:</strong> <span id="userCount">0</span> ä¸ª<br>
                    <strong>è®¾å¤‡æ•°é‡:</strong> <span id="assetCount">0</span> ä¸ª<br>
                    <strong>å·¥å•æ•°é‡:</strong> <span id="workorderCount">0</span> ä¸ª
                </div>
                <div>
                    <strong>ä¿å…»è®¡åˆ’:</strong> <span id="planCount">0</span> ä¸ª<br>
                    <strong>å¤‡ä»¶æ•°é‡:</strong> <span id="partCount">0</span> ä¸ª<br>
                    <strong>æµ‹è¯•è¿›åº¦:</strong> <span id="completedTests">0</span>/8
                </div>
            </div>
        </div>

        <!-- éšè—çš„é¡µé¢å®¹å™¨ -->
        <div id="page-workorders" style="display: none;"></div>
        <div id="page-maintenance" style="display: none;"></div>
        <div id="page-assets" style="display: none;"></div>
        <div id="page-spareparts" style="display: none;"></div>
    </div>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/workorders.js"></script>
    <script src="/static/js/maintenance.js"></script>
    <script src="/static/js/index.js"></script>

    <script>
        let authToken = null;
        let testResults = {};
        let completedTests = 0;
        let createdTestIds = {
            workorder: null,
            plan: null,
            asset: null
        };

        function updateResult(testNum, message, type = 'info') {
            const element = document.getElementById(`test${testNum}Result`);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML = `<div class="test-section ${className}" style="margin-top: 10px;">${message}</div>`;
        }

        function updateProgress() {
            const progress = (completedTests / 8) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${completedTests}/8 å®Œæˆ`;
            document.getElementById('completedTests').textContent = completedTests;
        }

        function updateStatus() {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');
            
            document.getElementById('loginStatus').textContent = token ? 'å·²ç™»å½•' : 'æœªç™»å½•';
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    document.getElementById('userInfo').textContent = `${userData.username} (${userData.role})`;
                } catch (e) {
                    document.getElementById('userInfo').textContent = 'è§£æé”™è¯¯';
                }
            }
        }

        async function runTest(testNum, testFunction) {
            updateResult(testNum, 'ğŸ”„ æµ‹è¯•è¿›è¡Œä¸­...', 'info');
            
            try {
                const result = await testFunction();
                if (result) {
                    testResults[testNum] = true;
                    completedTests++;
                    updateProgress();
                }
            } catch (error) {
                console.error(`æµ‹è¯• ${testNum} å¤±è´¥:`, error);
                updateResult(testNum, `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const response = await fetch('/api/auth/login/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'admin', password: 'admin123' })
            });

            if (response.ok) {
                const data = response.json();
                authToken = data.access;
                localStorage.setItem('access_token', data.access);
                localStorage.setItem('refresh_token', data.refresh);
                localStorage.setItem('user', JSON.stringify(data.user));
                
                updateResult(1, `âœ… ç™»å½•æˆåŠŸï¼<br>ç”¨æˆ·: ${data.user.username}<br>è§’è‰²: ${data.user.role}`, 'success');
                updateStatus();
                return true;
            } else {
                throw new Error(`ç™»å½•å¤±è´¥: ${response.status}`);
            }
        }

        async function testUsersAPI() {
            const response = await API.get('/auth/users/', { page_size: 1000 });
            const users = response.results || [];
            
            document.getElementById('userCount').textContent = users.length;
            updateResult(2, `âœ… ç”¨æˆ·APIæµ‹è¯•æˆåŠŸï¼<br>è·å–åˆ° ${users.length} ä¸ªç”¨æˆ·`, 'success');
            return true;
        }

        async function testAssetsModule() {
            if (typeof loadAssets === 'function') {
                await loadAssets();
                
                const response = await API.getAssets({ page_size: 1000 });
                const assets = response.results || [];
                
                document.getElementById('assetCount').textContent = assets.length;
                updateResult(3, `âœ… è®¾å¤‡ç®¡ç†æµ‹è¯•æˆåŠŸï¼<br>é¡µé¢åŠ è½½æ­£å¸¸ï¼Œè·å–åˆ° ${assets.length} ä¸ªè®¾å¤‡`, 'success');
                return true;
            } else {
                throw new Error('loadAssetså‡½æ•°ä¸å­˜åœ¨');
            }
        }

        async function testWorkOrderModule() {
            if (typeof loadWorkOrders === 'function' && typeof showWorkOrderModal === 'function') {
                await loadWorkOrders();
                
                const response = await API.getWorkOrders({ page_size: 1000 });
                const workorders = response.results || [];
                
                document.getElementById('workorderCount').textContent = workorders.length;
                updateResult(4, `âœ… å·¥å•ç®¡ç†æµ‹è¯•æˆåŠŸï¼<br>é¡µé¢åŠ è½½æ­£å¸¸ï¼Œè·å–åˆ° ${workorders.length} ä¸ªå·¥å•<br>åˆ›å»ºæ¨¡æ€æ¡†åŠŸèƒ½æ­£å¸¸`, 'success');
                return true;
            } else {
                throw new Error('å·¥å•ç®¡ç†å‡½æ•°ä¸å­˜åœ¨');
            }
        }

        async function testMaintenanceModule() {
            if (typeof loadMaintenance === 'function' && typeof loadMaintenancePlans === 'function') {
                await loadMaintenance();
                await loadMaintenancePlans();
                
                const response = await API.getMaintenancePlans({ page_size: 1000 });
                const plans = response.results || [];
                
                document.getElementById('planCount').textContent = plans.length;
                updateResult(5, `âœ… ä¿å…»è®¡åˆ’æµ‹è¯•æˆåŠŸï¼<br>é¡µé¢åŠ è½½æ­£å¸¸ï¼Œè·å–åˆ° ${plans.length} ä¸ªä¿å…»è®¡åˆ’<br>æ‰€æœ‰å‡½æ•°éƒ½å­˜åœ¨`, 'success');
                return true;
            } else {
                throw new Error('ä¿å…»è®¡åˆ’å‡½æ•°ä¸å­˜åœ¨');
            }
        }

        async function testSparePartsModule() {
            if (typeof loadSpareParts === 'function') {
                await loadSpareParts();
                
                const response = await API.getSpareParts({ page_size: 1000 });
                const parts = response.results || [];
                
                document.getElementById('partCount').textContent = parts.length;
                updateResult(6, `âœ… å¤‡ä»¶ç®¡ç†æµ‹è¯•æˆåŠŸï¼<br>é¡µé¢åŠ è½½æ­£å¸¸ï¼Œè·å–åˆ° ${parts.length} ä¸ªå¤‡ä»¶`, 'success');
                return true;
            } else {
                throw new Error('loadSparePartså‡½æ•°ä¸å­˜åœ¨');
            }
        }

        async function testWorkOrderFlow() {
            // è·å–è®¾å¤‡åˆ—è¡¨
            const assetsResponse = await API.getAssets({ page_size: 10 });
            const assets = assetsResponse.results || [];
            
            if (assets.length === 0) {
                throw new Error('æ²¡æœ‰å¯ç”¨è®¾å¤‡');
            }

            // åˆ›å»ºæµ‹è¯•å·¥å•
            const workorderData = {
                equipment: assets[0].id,
                wo_type: 'CM',
                summary: 'é›†æˆæµ‹è¯•å·¥å•',
                description: 'è¿™æ˜¯ä¸€ä¸ªé›†æˆæµ‹è¯•åˆ›å»ºçš„å·¥å•',
                priority: 'medium',
                status: 'open'
            };

            const createResponse = await API.createWorkOrder(workorderData);
            createdTestIds.workorder = createResponse.id;

            // æµ‹è¯•å·¥å•çŠ¶æ€æµè½¬
            await API.startWorkOrder(createResponse.id);
            await API.completeWorkOrder(createResponse.id, {
                actions_taken: 'å®Œæˆæµ‹è¯•ç»´ä¿®',
                root_cause: 'æµ‹è¯•åŸå› ',
                downtime_minutes: 30,
                labor_hours: 2.0,
                parts_cost: 100.0
            });
            await API.closeWorkOrder(createResponse.id);

            updateResult(7, `âœ… å·¥å•æµç¨‹æµ‹è¯•æˆåŠŸï¼<br>å·¥å•: ${createResponse.wo_code}<br>çŠ¶æ€æµè½¬: å¼€æ”¾ â†’ è¿›è¡Œä¸­ â†’ å®Œæˆ â†’ å…³é—­`, 'success');
            return true;
        }

        async function cleanupTestData() {
            let cleaned = 0;
            
            // æ¸…ç†æµ‹è¯•å·¥å•
            if (createdTestIds.workorder) {
                try {
                    await API.deleteWorkOrder(createdTestIds.workorder);
                    cleaned++;
                } catch (e) {
                    console.log('å·¥å•å·²ä¸å­˜åœ¨æˆ–å·²åˆ é™¤');
                }
            }

            updateResult(8, `âœ… æ¸…ç†å®Œæˆï¼<br>æ¸…ç†äº† ${cleaned} ä¸ªæµ‹è¯•æ•°æ®é¡¹`, 'success');
            document.getElementById('testStatus').textContent = 'æµ‹è¯•å®Œæˆ';
            return true;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            updateStatus();
            updateProgress();
            console.log('ğŸš€ CMMSç³»ç»Ÿé›†æˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
        });

        // é”™è¯¯æ•è·
        window.addEventListener('error', function(e) {
            console.error('âŒ JavaScripté”™è¯¯:', e.message);
        });

        // è‡ªåŠ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            document.getElementById('testStatus').textContent = 'è‡ªåŠ¨æµ‹è¯•ä¸­';
            
            for (let i = 1; i <= 8; i++) {
                const testFunctions = [
                    null, testLogin, testUsersAPI, testAssetsModule, 
                    testWorkOrderModule, testMaintenanceModule, 
                    testSparePartsModule, testWorkOrderFlow, cleanupTestData
                ];
                
                if (testFunctions[i]) {
                    await runTest(i, testFunctions[i]);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
                }
            }
            
            document.getElementById('testStatus').textContent = 'è‡ªåŠ¨æµ‹è¯•å®Œæˆ';
        }

        // æ·»åŠ è‡ªåŠ¨æµ‹è¯•æŒ‰é’®
        setTimeout(() => {
            const container = document.querySelector('.test-container');
            const autoTestBtn = document.createElement('button');
            autoTestBtn.className = 'btn btn-danger';
            autoTestBtn.textContent = 'ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•';
            autoTestBtn.onclick = runAllTests;
            autoTestBtn.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000;';
            document.body.appendChild(autoTestBtn);
        }, 1000);
    </script>
</body>
</html>